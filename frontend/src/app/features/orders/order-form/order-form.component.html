<div class="page-header">
  <h1>{{ title() }}</h1>
  <a routerLink="/orders" class="btn">Cancel</a>
</div>

@if (orderService.loading()) {
  <div class="loading">Loading...</div>
}

@if (orderService.error()) {
  <div class="error">{{ orderService.error() }}</div>
}

<form class="form-card" (ngSubmit)="onSubmit()">
  <div class="form-section">
    <h3>Customer Information</h3>

    <div class="form-group">
      <label for="customerName">Customer Name</label>
      <input
        type="text"
        id="customerName"
        [ngModel]="formData().customerName"
        (ngModelChange)="updateField('customerName', $event)"
        name="customerName"
        required
        placeholder="Enter customer name"
      />
    </div>

    <div class="form-group">
      <label for="customerEmail">Email</label>
      <input
        type="email"
        id="customerEmail"
        [ngModel]="formData().customerEmail"
        (ngModelChange)="updateField('customerEmail', $event)"
        name="customerEmail"
        required
        placeholder="customer@example.com"
      />
    </div>

    <div class="form-group">
      <label for="customerAddress">Address</label>
      <textarea
        id="customerAddress"
        [ngModel]="formData().customerAddress"
        (ngModelChange)="updateField('customerAddress', $event)"
        name="customerAddress"
        rows="3"
        required
        placeholder="Enter customer address"
      ></textarea>
    </div>

    <div class="form-group">
      <label for="status">Status</label>
      <select
        id="status"
        [ngModel]="formData().status"
        (ngModelChange)="updateField('status', $event)"
        name="status"
      >
        @for (option of statusOptions; track option.value) {
          <option [value]="option.value">{{ option.label }}</option>
        }
      </select>
    </div>
  </div>

  @if (!isEditMode()) {
    <div class="form-section">
      <div class="section-header">
        <h3>Order Items</h3>
        <button type="button" class="btn btn-sm btn-primary" (click)="addOrderItem()">
          Add Item
        </button>
      </div>

      @if (orderItems().length === 0) {
        <p class="empty-message">No items added yet. Click "Add Item" to add products to this order.</p>
      }

      @for (item of orderItems(); track $index; let i = $index) {
        <div class="order-item-row">
          <div class="form-group">
            <label>Product</label>
            <select
              [ngModel]="item.productId"
              (ngModelChange)="updateOrderItem(i, 'productId', $event)"
              [name]="'productId_' + i"
              required
            >
              <option [value]="0" disabled>Select a product</option>
              @for (product of productService.products(); track product.id) {
                <option [value]="product.id">{{ product.name }} - {{ product.price | currency }}</option>
              }
            </select>
          </div>

          <div class="form-group quantity">
            <label>Quantity</label>
            <input
              type="number"
              [ngModel]="item.quantity"
              (ngModelChange)="updateOrderItem(i, 'quantity', $event)"
              [name]="'quantity_' + i"
              required
              min="1"
            />
          </div>

          <div class="form-group price">
            <label>Unit Price</label>
            <input
              type="number"
              [ngModel]="item.unitPrice"
              (ngModelChange)="updateOrderItem(i, 'unitPrice', $event)"
              [name]="'unitPrice_' + i"
              required
              min="0"
              step="0.01"
            />
          </div>

          <div class="form-group item-total">
            <label>Total</label>
            <span>{{ item.quantity * item.unitPrice | currency }}</span>
          </div>

          <button type="button" class="btn btn-sm btn-danger remove-btn" (click)="removeOrderItem(i)">
            Remove
          </button>
        </div>
      }

      @if (orderItems().length > 0) {
        <div class="order-total">
          <strong>Order Total: {{ orderTotal() | currency }}</strong>
        </div>
      }
    </div>
  }

  <div class="form-actions">
    <button type="submit" class="btn btn-primary" [disabled]="orderService.loading()">
      @if (isEditMode()) {
        Update Order
      } @else {
        Create Order
      }
    </button>
    <a routerLink="/orders" class="btn btn-secondary">Cancel</a>
  </div>
</form>
